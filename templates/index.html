<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🎓 EduGenius - Multilingual Education Advisor</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Animate.css -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <!-- Particles.js -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <!-- SweetAlert2 -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <!-- Custom Styles -->
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3a0ca3;
      --accent-color: #f72585;
      --light-primary: #e0fbfc;
      --dark-color: #1a1a2e;
      --bg-color: #f8f9fa;
      --msg-user: #4361ee;
      --msg-bot: #e0f7fa;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: var(--bg-color);
      overflow: hidden;
      color: var(--dark-color);
    }
    
    #particles-js {
      position: absolute;
      width: 100%;
      height: 100%;
      z-index: -1;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    
    .chat-container {
      max-width: 800px;
      margin: 2rem auto;
      height: 90vh;
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      border-radius: 20px;
      overflow: hidden;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .chat-header {
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 1.2rem;
      text-align: center;
      position: relative;
      border-bottom: 2px solid rgba(255,255,255,0.2);
    }
    
    .chat-header h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .chat-header small {
      opacity: 0.9;
      font-size: 0.9rem;
    }
    
    .language-selector {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 5px;
    }
    
    .language-selector select {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.2rem 0.5rem;
      border-radius: 5px;
      font-size: 0.8rem;
      outline: none;
    }
    
    .language-selector select option {
      color: var(--dark-color);
    }
    
    .chat-body {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      background: var(--light-primary);
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%234361ee' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    
    .chat-body::-webkit-scrollbar {
      width: 8px;
    }
    
    .chat-body::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .chat-body::-webkit-scrollbar-thumb {
      background-color: rgba(67, 97, 238, 0.5);
      border-radius: 10px;
    }
    
    .message {
      max-width: 80%;
      margin-bottom: 1rem;
      padding: 1rem 1.2rem;
      border-radius: 1.2rem;
      position: relative;
      word-break: break-word;
      animation: fadeInUp 0.4s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      line-height: 1.5;
    }
    
    .message.user {
      background: var(--msg-user);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 0.3rem;
    }
    
    .message.bot {
      background: var(--msg-bot);
      color: var(--dark-color);
      margin-right: auto;
      border-bottom-left-radius: 0.3rem;
    }
    
    .message-actions {
      position: absolute;
      right: -30px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .message-actions button {
      background: white;
      border: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: all 0.2s;
      color: var(--primary-color);
    }
    
    .message-actions button:hover {
      background: var(--primary-color);
      color: white;
      transform: scale(1.1);
    }
    
    .chat-footer {
      padding: 1rem;
      border-top: 1px solid rgba(0,0,0,0.1);
      background: white;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .chat-footer input {
      flex: 1;
      border: 2px solid rgba(67, 97, 238, 0.3);
      padding: 0.8rem 1.2rem;
      border-radius: 2rem;
      background: white;
      outline: none;
      transition: all 0.3s;
      font-size: 1rem;
    }
    
    .chat-footer input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }
    
    .chat-footer button {
      background: var(--primary-color);
      border: none;
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 1.3rem;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    .chat-footer button:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
    }
    
    .chat-footer button:active {
      transform: translateY(0);
    }
    
    /* Loader animation */
    .loader {
      display: flex;
      gap: 6px;
      align-items: center;
      padding: 1rem 1.5rem;
    }
    
    .loader div {
      width: 10px;
      height: 10px;
      background: var(--primary-color);
      border-radius: 50%;
      animation: bounce 0.8s infinite alternate;
    }
    
    .loader div:nth-child(2) { animation-delay: 0.2s; }
    .loader div:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes bounce {
      to { opacity: 0.3; transform: translateY(-10px); }
    }
    
    /* Welcome animation */
    .welcome-message {
      text-align: center;
      padding: 2rem;
      background: linear-gradient(135deg, rgba(67, 97, 238, 0.1), rgba(247, 37, 133, 0.1));
      border-radius: 15px;
      margin: 1rem;
      animation: fadeIn 1s;
    }
    
    .welcome-message h3 {
      color: var(--primary-color);
      margin-bottom: 1rem;
    }
    
    .arrow-down {
      text-align: center;
      font-size: 2rem;
      color: var(--primary-color);
      animation: bounce 2s infinite;
      margin: 1rem 0;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .chat-container {
        margin: 0;
        height: 100vh;
        border-radius: 0;
      }
      
      .message {
        max-width: 90%;
      }
      
      .message-actions {
        right: -25px;
      }
    }
    
    /* Markdown styling */
    .message.bot strong {
      color: var(--secondary-color);
    }
    
    .message.bot ul, 
    .message.bot ol {
      padding-left: 1.5rem;
      margin: 0.5rem 0;
    }
    
    .message.bot li {
      margin-bottom: 0.3rem;
    }
  </style>
</head>
<body>
  <div id="particles-js"></div>
  
  <div class="chat-container d-flex flex-column animate__animated animate__fadeIn">
    <div class="chat-header">
      <div class="language-selector">
        <select id="input-lang" title="Input Language">
          {% for code, lang in languages.items() %}
            <option value="{{ code }}" {% if code == 'en' %}selected{% endif %}>{{ lang.flag }} {{ lang.name }}</option>
          {% endfor %}
        </select>
        <select id="output-lang" title="Output Language">
          {% for code, lang in languages.items() %}
            <option value="{{ code }}" {% if code == 'en' %}selected{% endif %}>{{ lang.flag }} {{ lang.name }}</option>
          {% endfor %}
        </select>
      </div>
      <h1><i class="fas fa-graduation-cap"></i> EduGenius</h1>
      <small>Your multilingual US education advisor</small>
    </div>

    <div id="chat-body" class="chat-body">
      <div class="welcome-message animate__animated animate__fadeIn">
        <h3>Welcome to EduGenius! <i class="fas fa-robot"></i></h3>
        <p>Ask me anything about US higher education, admissions, scholarships, deadlines, and more!</p>
        <p>Select your preferred languages above for multilingual support.</p>
        <div class="arrow-down">
          <i class="fas fa-arrow-down"></i>
        </div>
      </div>
    </div>

    <div class="chat-footer">
      <input type="text" id="user-input" placeholder="Type your question here..." autocomplete="off" />
      <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>

  <!-- jQuery & Bootstrap JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <!-- Marked.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    $(function() {
      // Initialize particles.js
      particlesJS("particles-js", {
        "particles": {
          "number": { "value": 80, "density": { "enable": true, "value_area": 800 } },
          "color": { "value": "#4361ee" },
          "shape": { "type": "circle", "stroke": { "width": 0, "color": "#000000" } },
          "opacity": { "value": 0.5, "random": true },
          "size": { "value": 3, "random": true },
          "line_linked": { "enable": true, "distance": 150, "color": "#4361ee", "opacity": 0.3, "width": 1 },
          "move": { "enable": true, "speed": 2, "direction": "none", "random": true, "straight": false, "out_mode": "out" }
        },
        "interactivity": {
          "detect_on": "canvas",
          "events": {
            "onhover": { "enable": true, "mode": "grab" },
            "onclick": { "enable": true, "mode": "push" },
            "resize": true
          },
          "modes": { "grab": { "distance": 140, "line_linked": { "opacity": 0.8 } } }
        }
      });

      const $body = $('#chat-body');
      const $input = $('#user-input');
      const $btn = $('#send-btn');
      const $inputLang = $('#input-lang');
      const $outputLang = $('#output-lang');
      
      // Show language selection hint
      setTimeout(() => {
        Swal.fire({
          title: 'Language Selection',
          text: 'You can select different languages for input and output using the dropdowns in the top right corner.',
          icon: 'info',
          timer: 3000,
          timerProgressBar: true,
          toast: true,
          position: 'top-end',
          showConfirmButton: false
        });
      }, 2000);

      function scrollBottom() {
        $body.stop().animate({ scrollTop: $body[0].scrollHeight }, 400);
      }

      function appendMessage(text, sender) {
        const cls = sender === 'user' ? 'user' : 'bot';
        const $msg = $(`
          <div class="message ${cls} animate__animated animate__fadeInUp">
            ${sender === 'bot' ? marked.parse(text) : text}
            <div class="message-actions">
              ${sender === 'bot' ? `<button class="speak-btn" title="Listen"><i class="fas fa-volume-up"></i></button>` : ''}
              ${sender === 'bot' ? `<button class="download-btn" title="Download"><i class="fas fa-download"></i></button>` : ''}
            </div>
          </div>
        `);
        $body.append($msg);
        
        // Attach event handlers to new buttons
        if (sender === 'bot') {
          $msg.find('.speak-btn').on('click', function() {
            speakMessage(text);
          });
          
          $msg.find('.download-btn').on('click', function() {
            downloadMessage(text);
          });
        }
        
        scrollBottom();
      }

      function speakMessage(text) {
        const lang = $outputLang.val();
        $.ajax({
          url: '/speak',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ 
            text: text,
            lang: lang
          }),
          success: function() {
            Swal.fire({
              title: 'Speaking',
              text: `Playing response in ${$outputLang.find('option:selected').text()}`,
              icon: 'info',
              timer: 2000,
              timerProgressBar: true,
              toast: true,
              position: 'top-end',
              showConfirmButton: false
            });
          },
          error: function() {
            Swal.fire({
              title: 'Error',
              text: 'Could not play audio',
              icon: 'error',
              timer: 2000,
              timerProgressBar: true,
              toast: true,
              position: 'top-end',
              showConfirmButton: false
            });
          }
        });
      }

      function downloadMessage(text) {
        const lang = $outputLang.val();
        $.ajax({
          url: '/download',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ 
            text: text,
            lang: lang
          }),
          success: function(response) {
            if (response.status === 'success') {
              // Create invisible link and trigger click
              const a = document.createElement('a');
              a.href = response.url;
              a.download = `edugenius_response_${new Date().toISOString().slice(0,10)}.txt`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            }
          },
          error: function() {
            Swal.fire({
              title: 'Error',
              text: 'Could not download response',
              icon: 'error',
              timer: 2000,
              timerProgressBar: true,
              toast: true,
              position: 'top-end',
              showConfirmButton: false
            });
          }
        });
      }

      function showLoader() {
        const $loader = $('<div class="message bot loader animate__animated animate__fadeIn"></div>');
        for (let i = 0; i < 3; i++) {
          $loader.append('<div></div>');
        }
        $body.append($loader);
        scrollBottom();
        return $loader;
      }

      function sendQuery() {
        const query = $input.val().trim();
        if (!query) return;
        
        appendMessage(query, 'user');
        $input.val('');
        
        const $loader = showLoader();
        const inputLang = $inputLang.val();
        const outputLang = $outputLang.val();

        $.ajax({
          url: '/ask',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ 
            query: query,
            input_lang: inputLang,
            output_lang: outputLang
          }),
          success: function(response) {
            $loader.remove();
            appendMessage(response.response, 'bot');
            
            // Show language notification if not English
            if (response.lang !== 'en') {
              const langName = $outputLang.find('option[value="' + response.lang + '"]').text();
              Swal.fire({
                title: 'Translated Response',
                text: `Displaying in ${langName}`,
                icon: 'info',
                timer: 2000,
                timerProgressBar: true,
                toast: true,
                position: 'top-end',
                showConfirmButton: false
              });
            }
          },
          error: function() {
            $loader.remove();
            appendMessage('❌ Error contacting the server. Please try again.', 'bot');
          }
        });
      }

      // Event handlers
      $btn.on('click', sendQuery);
      $input.on('keydown', function(e) { 
        if (e.key === 'Enter') sendQuery(); 
      });
      
      // Auto-focus input
      setTimeout(() => {
        $input.focus();
      }, 500);
    });
  </script>
</body>
</html>